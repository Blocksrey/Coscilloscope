#include <stdio.h>
#include <stdlib.h>
#include "prim.h"
#include "ppm.h"
#include "math.h"

#define W 600
#define H 400

static f32 pixels[W*H][3];

#define SET_PIXEL(x, y, g) pixels[x + W*(y)][1] = g
#define ADD_PIXEL(x, y, g) pixels[x + W*(y)][1] += g
#define MUL_PIXEL(x, y, g) pixels[x + W*(y)][1] *= g
#define LENGTH(a) (sizeof a/sizeof *a)
#define DOT(x0, y0, x1, y1) ((x0)*(x1) + (y0)*(y1))
#define DD(x0, y0) ((x0)*(x0) + (y0)*(y0))
#define TAU 6.2831853f

typedef struct {
	f32 a;
	f32 p;
} fti;

static void dft(u16 n, f32 *v, fti *o) {
	for (u16 f = n; f--;) {
		f32 x = 0;
		f32 y = 0;

		for (u16 i = n; i--;) {
			x += v[i]*COSP(TAU*(float)(f*i)/n);
			y -= v[i]*SINP(TAU*(float)(f*i)/n);
		}

		x /= n;
		y /= n;

		o[f].a = SQRT(x*x + y*y);
		o[f].p = ATAN(x, y);
	}
}

static f32 dc(u16 n, fti *o, f32 t, f32 x) {
	for (u16 f = n; f--;)
		x += o[f].a*COSP(f*t + o[f].p);

	return x;
}

int main() {
	/*
	f32 POINTS[] = {
		94,302,
		111,289,
		130,276,
		151,270,
		165,256,
		172,232,
		178,214,
		174,193,
		169,174,
		174,159,
		197,157,
		201,169,
		199,190,
		193,197,
		169,178,
		165,157,
		165,136,
		167,115,
		176,96,
		186,83,
		214,75,
		230,71,
		256,71,
		274,75,
		295,88,
		312,98,
		325,104,
		329,113,
		300,113,
		276,113,
		247,117,
		285,115,
		314,121,
		321,134,
		321,146,
		318,157,
		321,176,
		333,180,
		358,172,
		375,157,
		377,142,
		365,121,
		348,117,
		321,117,
		314,128,
		318,151,
		316,169,
		312,176,
		302,172,
		304,180,
		308,188,
		304,195,
		306,209,
		291,211,
		274,209,
		279,197,
		287,195,
		270,176,
		253,169,
		266,161,
		276,167,
		285,155,
		268,153,
		249,153,
		266,153,
		281,155,
		279,167,
		270,180,
		272,193,
		270,209,
		300,203,
		306,216,
		304,228,
		300,222,
		283,222,
		262,224,
		256,232,
		266,243,
		272,260,
		287,256,
		291,247,
		281,241,
		270,235,
		285,241,
		291,247,
		291,260,
		285,268,
		272,281,
		258,279,
		247,272,
		232,268,
		247,274,
		253,285,
		247,300,
		235,297,
		209,293,
		188,283,
		176,276,
		165,268,
		203,289,
		226,302,
		251,304,
		256,314,
		266,329,
		276,346
	};
	*/

	f32 POINTS[] = {
		453,98,
		793,94,
		988,256,
		984,532,
		788,719,
		449,713,
		300,493,
		321,264,
		449,98,
		516,312,
		505,304,
		495,300,
		472,297,
		451,310,
		438,321,
		436,337,
		436,354,
		453,369,
		484,375,
		505,384,
		520,400,
		520,432,
		501,461,
		488,465,
		451,463,
		430,449,
		430,446,
		570,304,
		602,304,
		621,306,
		635,306,
		650,306,
		671,304,
		627,312,
		625,337,
		625,354,
		627,384,
		627,423,
		623,444,
		623,457,
		770,302,
		755,302,
		736,316,
		723,333,
		721,354,
		721,377,
		732,409,
		740,428,
		755,446,
		761,453,
		780,446,
		791,425,
		791,411,
		795,384,
		791,352,
		786,325,
		786,318,
		837,302,
		835,314,
		835,333,
		835,356,
		837,388,
		843,428,
		837,484,
		845,453,
		837,417,
		843,297,
		849,295,
		868,293,
		889,289,
		896,308,
		904,321,
		904,335,
		881,356,
		866,363,
		860,363

	};

	u16 N = LENGTH(POINTS)/2;

	f32 xs[N];
	f32 ys[N];

	f32 lx =  10000000;
	f32 ly =  10000000;
	f32 hx = -10000000;
	f32 hy = -10000000;

	for (u16 i = 0; i < N; ++i) {
		xs[i] = POINTS[2*i + 0];
		ys[i] = POINTS[2*i + 1];

		lx = MIN(xs[i], lx);
		ly = MIN(ys[i], ly);
		hx = MAX(xs[i], hx);
		hy = MAX(ys[i], hy);
	}

	for (u16 i = 0; i < N; ++i) {
		xs[i] -= (lx + hx)/2;
		ys[i] -= (ly + hy)/2;

		xs[i] *= W/(hx - lx)/2;
		ys[i] *= H/(hy - lx)/2;
	}

	fti fx[N];
	fti fy[N];

	dft(N, xs, fx);
	dft(N, ys, fy);



	f32 dx;
	f32 dy;
	f32 pr = 5*PI; // pi*radius


	f32 time = 0.0f;

	f32 ox = dc(N, fx, time, 0.5f*W);
	f32 oy = dc(N, fy, time, 0.5f*H);

	char fs[24];

	u16 px, py;

	for (u16 i = 0; i < 3*N; ++i) {
		sprintf(fs, "output/%05d.ppm", i);

		f32 bx = ox;
		f32 by = oy;

		time += TAU/N;

		ox = dc(N, fx, time, 0.5f*W);
		oy = dc(N, fy, time, 0.5f*H);

		dx = bx - ox;
		dy = by - oy;

		for (u32 p = 0; p < W*H; ++p) {
			px = p%W;
			py = p/W;
			f32 l = SQRT(dx*dx + dy*dy);
			f32 ux = dx/l;
			f32 uy = dy/l;
			f32 z = CLAMP(DOT(ux, uy, px - ox, py - oy), 0, l);
			f32 b = 2*pr/(pr + 2*l)/MAX(1, POW(DD(ox + z*ux - px, oy + z*uy - py), 0.666666f));
			ADD_PIXEL(px, py, b);
			MUL_PIXEL(px, py, 0.98f);
		}

		writePPM(pixels, W, H, fs);
	}

	return 0;
}
